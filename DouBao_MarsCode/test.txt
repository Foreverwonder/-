import requests
import json
import time
import os
import mimetypes
import tkinter as tk
from tkinter import ttk, scrolledtext, filedialog, messagebox
from PIL import Image, ImageTk
import threading
from ttkthemes import ThemedTk
import emoji

try:
    from tkinterdnd2 import DND_FILES, TkinterDnD
except ImportError:
    # å¦‚æœæ²¡æœ‰å®‰è£… tkinterdnd2ï¼Œç¦ç”¨æ‹–æ”¾åŠŸèƒ½
    DND_FILES = None
    TkinterDnD = None

class ModernUI:
    # æ·±è‰²ä¸»é¢˜é…è‰²
    DARK_THEME = {
        'bg': '#1e1e1e',           # æ›´æ·±çš„èƒŒæ™¯è‰²
        'fg': '#ffffff',           # ç™½è‰²æ–‡å­—
        'input_bg': '#2d2d2d',     # è¾“å…¥æ¡†èƒŒæ™¯
        'button_bg': '#0078d4',    # å¾®è½¯è“æŒ‰é’®
        'button_fg': '#ffffff',    # æŒ‰é’®æ–‡å­—é¢œè‰²
        'highlight': '#0078d4',    # é«˜äº®é¢œè‰²
        'border': '#3d3d3d',       # è¾¹æ¡†é¢œè‰²
        'hover': '#106ebe'         # æ‚¬åœé¢œè‰²
    }
    
    # æµ…è‰²ä¸»é¢˜é…è‰²
    LIGHT_THEME = {
        'bg': '#ffffff',           # çº¯ç™½èƒŒæ™¯
        'fg': '#2c2c2c',           # æ·±ç°æ–‡å­—
        'input_bg': '#f5f5f5',     # æµ…ç°è¾“å…¥æ¡†
        'button_bg': '#0078d4',    # å¾®è½¯è“æŒ‰é’®
        'button_fg': '#ffffff',    # æŒ‰é’®æ–‡å­—é¢œè‰²
        'highlight': '#0078d4',    # é«˜äº®é¢œè‰²
        'border': '#e0e0e0',       # è¾¹æ¡†é¢œè‰²
        'hover': '#106ebe'         # æ‚¬åœé¢œè‰²
    }

class CozeAPI:
    # æ”¯æŒçš„æ–‡ä»¶ç±»å‹
    SUPPORTED_DOCUMENTS = {
        '.doc': 'application/msword',
        '.docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        '.xls': 'application/vnd.ms-excel',
        '.xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        '.ppt': 'application/vnd.ms-powerpoint',
        '.pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        '.pdf': 'application/pdf',
        '.numbers': 'application/x-iwork-numbers-sffnumbers',
        '.csv': 'text/csv'
    }
    
    SUPPORTED_IMAGES = {
        '.jpg': 'image/jpeg',
        '.jpeg': 'image/jpeg',
        '.jpg2': 'image/jpeg2000',
        '.png': 'image/png',
        '.gif': 'image/gif',
        '.webp': 'image/webp',
        '.heic': 'image/heic',
        '.heif': 'image/heif',
        '.bmp': 'image/bmp',
        '.pcd': 'image/x-photo-cd',
        '.tiff': 'image/tiff',
        '.tif': 'image/tiff'
    }

    def __init__(self, auth_token):
        # éªŒè¯token
        if not auth_token or len(auth_token) < 10:
            raise ValueError("æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ")
            
        self.base_url = "https://api.coze.cn/v3"
        self.upload_url = "https://api.coze.cn/v1/files/upload"
        self.auth_token = auth_token
        self.headers = {
            "Authorization": f"Bearer {auth_token}",
            "Content-Type": "application/json"
        }
        
        # é…ç½®é‡è¯•ç­–ç•¥
        retry_strategy = requests.adapters.Retry(
            total=5,  # æ€»é‡è¯•æ¬¡æ•°
            backoff_factor=0.5,  # é‡è¯•é—´éš”
            status_forcelist=[500, 502, 503, 504],  # éœ€è¦é‡è¯•çš„HTTPçŠ¶æ€ç 
            allowed_methods=["GET", "POST"]  # å…è®¸é‡è¯•çš„è¯·æ±‚æ–¹æ³•
        )
        
        # åˆ›å»ºå¸¦æœ‰é‡è¯•ç­–ç•¥çš„session
        self.session = requests.Session()
        adapter = requests.adapters.HTTPAdapter(max_retries=retry_strategy)
        self.session.mount("http://", adapter)
        self.session.mount("https://", adapter)
        self.session.headers.update(self.headers)
        
        # æ·»åŠ è¯·æ±‚æ§åˆ¶
        self.last_request_time = 0
        self.min_request_interval = 0.5  # æœ€å°è¯·æ±‚é—´éš”(ç§’)
        
    def _wait_for_rate_limit(self):
        """æ§åˆ¶è¯·æ±‚é¢‘ç‡"""
        current_time = time.time()
        time_since_last_request = current_time - self.last_request_time
        if time_since_last_request < self.min_request_interval:
            time.sleep(self.min_request_interval - time_since_last_request)
        self.last_request_time = time.time()

    def get_file_type(self, file_path):
        """è·å–æ–‡ä»¶ç±»å‹å’ŒMIMEç±»å‹"""
        ext = os.path.splitext(file_path)[1].lower()
        
        if ext in self.SUPPORTED_DOCUMENTS:
            return 'document', self.SUPPORTED_DOCUMENTS[ext]
        elif ext in self.SUPPORTED_IMAGES:
            return 'image', self.SUPPORTED_IMAGES[ext]
        else:
            supported_formats = list(self.SUPPORTED_DOCUMENTS.keys()) + list(self.SUPPORTED_IMAGES.keys())
            raise ValueError(f"ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: {ext}ã€‚æ”¯æŒçš„æ ¼å¼: {', '.join(supported_formats)}")

    def upload_file(self, file_path, timeout=30):
        """ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨"""
        # æ§åˆ¶è¯·æ±‚é¢‘ç‡
        self._wait_for_rate_limit()
        
        if not os.path.exists(file_path):
            raise FileNotFoundError(f"æ–‡ä»¶ä¸å­˜åœ¨: {file_path}")
            
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        file_size = os.path.getsize(file_path)
        if file_size > 512 * 1024 * 1024:  # 512 MB
            raise ValueError(f"æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆ512MBï¼‰ï¼šå½“å‰å¤§å° {file_size / 1024 / 1024:.2f}MB")
            
        # è·å–æ–‡ä»¶ç±»å‹
        file_type, mime_type = self.get_file_type(file_path)
        
        # è®¾ç½®ä¸Šä¼ æ–‡ä»¶çš„headersï¼ˆæ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦Content-Typeï¼‰
        headers = {
            "Authorization": f"Bearer {self.auth_token}"
        }
        
        # å‡†å¤‡æ–‡ä»¶
        try:
            with open(file_path, 'rb') as file:
                files = {
                    'file': (
                        os.path.basename(file_path),  # æ–‡ä»¶å
                        file,                         # æ–‡ä»¶å¯¹è±¡
                        mime_type                     # MIMEç±»å‹
                    )
                }
                
                print(f"\næ­£åœ¨ä¸Šä¼ {file_type}: {os.path.basename(file_path)}")
                print(f"æ–‡ä»¶ç±»å‹: {mime_type}")
                print(f"æ–‡ä»¶å¤§å°: {file_size / 1024 / 1024:.2f}MB")
                
                # ä½¿ç”¨sessionè¿›è¡Œä¸Šä¼ 
                response = self.session.post(
                    self.upload_url,
                    headers=headers,
                    files=files,
                    timeout=timeout
                )
                
                # æ£€æŸ¥HTTPçŠ¶æ€ç 
                response.raise_for_status()
                
                try:
                    result = response.json()
                except json.JSONDecodeError as e:
                    print(f"JSONè§£æé”™è¯¯: {str(e)}")
                    print(f"å“åº”å†…å®¹: {response.text}")
                    raise Exception("æ–‡ä»¶ä¸Šä¼ å“åº”æ ¼å¼é”™è¯¯")
                
                # æ£€æŸ¥APIé”™è¯¯ç 
                if result.get("code") != 0:
                    error_msg = result.get("msg", "æœªçŸ¥é”™è¯¯")
                    error_code = result.get("code", -1)
                    raise Exception(f"æ–‡ä»¶ä¸Šä¼ å¤±è´¥ (ä»£ç : {error_code}): {error_msg}")
                
                # éªŒè¯å“åº”æ•°æ®
                if "data" not in result or not isinstance(result["data"], dict):
                    raise Exception(f"æ–‡ä»¶ä¸Šä¼ å“åº”æ•°æ®æ ¼å¼é”™è¯¯: {result}")
                
                file_id = result["data"].get("id")
                if not file_id:
                    raise Exception("å“åº”ä¸­æ²¡æœ‰æ–‡ä»¶ID")
                
                print(f"{file_type}ä¸Šä¼ æˆåŠŸï¼ID: {file_id}")
                return file_id, file_type
                    
        except requests.exceptions.RequestException as e:
            print(f"è¯·æ±‚é”™è¯¯: {str(e)}")
            raise Exception(f"æ–‡ä»¶ä¸Šä¼ è¯·æ±‚å¤±è´¥: {str(e)}")
        except Exception as e:
            print(f"æ–‡ä»¶ä¸Šä¼ å‡ºé”™: {str(e)}")
            raise

    def send_message(self, bot_id, user_id, message, user_name="User", file_path=None):
        # æ§åˆ¶è¯·æ±‚é¢‘ç‡
        self._wait_for_rate_limit()
        
        try:
            # å¦‚æœæä¾›äº†æ–‡ä»¶è·¯å¾„ï¼Œå…ˆä¸Šä¼ æ–‡ä»¶
            file_id = None
            file_type = None
            if file_path:
                try:
                    file_id, file_type = self.upload_file(file_path)
                except Exception as e:
                    print(f"æ–‡ä»¶ä¸Šä¼ å¤±è´¥: {str(e)}")
                    # å¦‚æœæ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œç»§ç»­å‘é€æ–‡æœ¬æ¶ˆæ¯
                    pass

            # å‡†å¤‡æ¶ˆæ¯å†…å®¹
            messages = []
            
            # æ·»åŠ æ–‡æœ¬æ¶ˆæ¯ï¼ˆå¿…é¡»åœ¨å‰é¢ï¼‰
            messages.append({
                "content_type": "text",
                "content": message,
                "role": "user",
                "name": user_name,
                "type": "question"
            })
            
            # å¦‚æœæœ‰æ–‡ä»¶ï¼Œæ·»åŠ æ–‡ä»¶æ¶ˆæ¯
            if file_id:
                file_content = {
                    "type": file_type,
                    "file_id": file_id,
                    "url": None  # ä¸Šä¼ æ—¶ä¸éœ€è¦URL
                }
                messages.append({
                    "content_type": "object_string",
                    "content": json.dumps([file_content]),
                    "role": "user",
                    "name": user_name,
                    "type": "question"
                })

            payload = {
                "bot_id": bot_id,
                "user_id": user_id,
                "additional_messages": messages
            }

            print("\nå‘é€è¯·æ±‚:")
            print(f"URL: {self.base_url}/chat")
            print("Payload:", json.dumps(payload, ensure_ascii=False, indent=2))
            
            # å‘é€è¯·æ±‚
            response = self.session.post(
                f"{self.base_url}/chat",
                json=payload,
                timeout=30  # æ·»åŠ è¶…æ—¶è®¾ç½®
            )
            
            print(f"\nå“åº”çŠ¶æ€ç : {response.status_code}")
            print("å“åº”å¤´:", dict(response.headers))
            
            # æ£€æŸ¥HTTPçŠ¶æ€ç 
            response.raise_for_status()
            
            try:
                data = response.json()
                print("\nå“åº”å†…å®¹:", json.dumps(data, ensure_ascii=False, indent=2))
            except json.JSONDecodeError as e:
                print(f"JSONè§£æé”™è¯¯: {str(e)}")
                print(f"åŸå§‹å“åº”å†…å®¹: {response.text}")
                raise Exception("APIå“åº”æ ¼å¼é”™è¯¯")
            
            # å¤„ç†APIé”™è¯¯ç 
            if data.get("code") != 0:
                error_msg = data.get("msg", "æœªçŸ¥é”™è¯¯")
                error_code = data.get("code", -1)
                raise Exception(f"APIé”™è¯¯ (ä»£ç : {error_code}): {error_msg}")
            
            if "data" not in data or not isinstance(data.get("data"), dict):
                raise Exception(f"API è¿”å›æ•°æ®æ ¼å¼é”™è¯¯: {data}")

            chat_id = data["data"]["id"]
            conversation_id = data["data"]["conversation_id"]
            
            print(f"\nå¼€å§‹ç­‰å¾…å›å¤ (chat_id: {chat_id}, conversation_id: {conversation_id})")
            
            # ç­‰å¾…å®Œæˆ
            max_wait_time = 60  # æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰
            start_time = time.time()
            
            while True:
                if time.time() - start_time > max_wait_time:
                    raise Exception(f"ç­‰å¾…å“åº”è¶…æ—¶ ({max_wait_time}ç§’)")
                    
                status = self.check_status(conversation_id, chat_id)
                print("\nçŠ¶æ€æ£€æŸ¥å“åº”:", json.dumps(status, ensure_ascii=False, indent=2))
                
                # æ£€æŸ¥çŠ¶æ€å“åº”çš„é”™è¯¯ç 
                if status.get("code") != 0:
                    error_msg = status.get("msg", "æœªçŸ¥é”™è¯¯")
                    error_code = status.get("code", -1)
                    raise Exception(f"çŠ¶æ€æ£€æŸ¥å¤±è´¥ (ä»£ç : {error_code}): {error_msg}")
                    
                if status["data"]["status"] == "completed":
                    print("\nå›å¤å·²å®Œæˆ")
                    break
                    
                time.sleep(1)
            
            # è·å–æ¶ˆæ¯åˆ—è¡¨
            print("\nè·å–æ¶ˆæ¯åˆ—è¡¨...")
            messages = self.get_messages(conversation_id, chat_id)
            
            # æ£€æŸ¥æ¶ˆæ¯åˆ—è¡¨å“åº”çš„é”™è¯¯ç 
            if messages.get("code") != 0:
                error_msg = messages.get("msg", "æœªçŸ¥é”™è¯¯")
                error_code = messages.get("code", -1)
                raise Exception(f"è·å–æ¶ˆæ¯å¤±è´¥ (ä»£ç : {error_code}): {error_msg}")
                
            return messages
            
        except requests.exceptions.Timeout:
            raise Exception("è¯·æ±‚è¶…æ—¶")
        except requests.exceptions.RequestException as e:
            raise Exception(f"ç½‘ç»œè¯·æ±‚é”™è¯¯: {str(e)}")
        except Exception as e:
            print(f"å‘é€æ¶ˆæ¯æ—¶å‡ºé”™: {str(e)}")
            import traceback
            print("è¯¦ç»†é”™è¯¯ä¿¡æ¯:")
            print(traceback.format_exc())
            raise

    def check_status(self, conversation_id, chat_id):
        url = f"{self.base_url}/chat/retrieve"
        params = {
            "conversation_id": conversation_id,
            "chat_id": chat_id
        }
        response = self.session.get(url, params=params)
        response.raise_for_status()
        return response.json()

    def get_messages(self, conversation_id, chat_id):
        url = f"{self.base_url}/chat/message/list"
        params = {
            "conversation_id": conversation_id,
            "chat_id": chat_id
        }
        response = self.session.get(url, params=params)
        response.raise_for_status()
        result = response.json()
        
        # æ·»åŠ è°ƒè¯•ä¿¡æ¯
        print("\nè·å–æ¶ˆæ¯å“åº”:", json.dumps(result, ensure_ascii=False, indent=2))
        return result

class CozeGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("AI æ™ºèƒ½åŠ©æ‰‹")
        self.root.geometry("1000x700")
        
        # è®¾ç½®ä¸»é¢˜
        self.current_theme = ModernUI.LIGHT_THEME
        self.setup_theme()
        
        # åˆ›å»º CozeAPI å®ä¾‹
        self.api = CozeAPI("pat_RZYft8z3yYWsykY49qZJjTwMyWN8uOzq652JPmTrfnNW4f9QhGx9VwaW81FPU6kP")
        self.selected_file = None
        self.user_id = None
        self.last_message = None
        self.last_user_id = None
        
        self.create_widgets()
        self.bind_shortcuts()
        
    def setup_theme(self):
        style = ttk.Style()
        style.theme_use('clam')
        
        # é…ç½®ä¸»é¢˜é¢œè‰²
        style.configure('Modern.TFrame', background=self.current_theme['bg'])
        
        # ä¸»æŒ‰é’®æ ·å¼
        style.configure('Modern.TButton', 
                       padding=(15, 8),
                       background=self.current_theme['button_bg'],
                       foreground=self.current_theme['button_fg'],
                       font=('Helvetica', 10))
        
        # å›¾æ ‡æŒ‰é’®æ ·å¼
        style.configure('Icon.TButton',
                       padding=(5, 5),
                       background=self.current_theme['button_bg'],
                       foreground=self.current_theme['button_fg'],
                       font=('Helvetica', 12))
        
        # Labelæ ·å¼
        style.configure('Modern.TLabel',
                       background=self.current_theme['bg'],
                       foreground=self.current_theme['fg'],
                       font=('Helvetica', 10))
        
        # è¾“å…¥æ¡†æ ·å¼
        style.configure('Chat.TEntry',
                       fieldbackground=self.current_theme['input_bg'],
                       foreground=self.current_theme['fg'],
                       insertcolor=self.current_theme['fg'])
        
        # æ·»åŠ çŠ¶æ€æ ‡ç­¾æ ·å¼
        style.configure('Status.TLabel',
                       background=self.current_theme['bg'],
                       foreground='#666666',  # ä½¿ç”¨æŸ”å’Œçš„ç°è‰²
                       font=('Helvetica', 9, 'italic'))  # ä½¿ç”¨æ–œä½“å°å­—å·

    def create_widgets(self):
        # åˆ›å»ºä¸»æ¡†æ¶
        self.main_frame = ttk.Frame(self.root, style='Modern.TFrame', padding="10")
        self.main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        
        # åˆ›å»ºé¡¶éƒ¨å·¥å…·æ 
        self.create_toolbar()
        
        # åˆ›å»ºèŠå¤©åŒºåŸŸ
        self.create_chat_area()
        
        # åˆ›å»ºè¾“å…¥åŒºåŸŸ
        self.create_input_area()
        
        # é…ç½®gridæƒé‡
        self.root.grid_rowconfigure(0, weight=1)
        self.root.grid_columnconfigure(0, weight=1)
        self.main_frame.grid_rowconfigure(2, weight=1)
        self.main_frame.grid_columnconfigure(0, weight=1)
        
    def create_toolbar(self):
        toolbar = ttk.Frame(self.main_frame, style='Modern.TFrame')
        toolbar.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=(0, 10))
        
        # éšè—ç”¨æˆ·IDï¼Œæ”¹ç”¨æ—¶é—´æˆ³è‡ªåŠ¨ç”Ÿæˆ
        self.user_id = f"user_{int(time.time())}"
        
        # å³ä¾§æŒ‰é’®ç»„
        btn_frame = ttk.Frame(toolbar, style='Modern.TFrame')
        btn_frame.pack(side=tk.RIGHT)
        
        # ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
        self.theme_btn = ttk.Button(btn_frame, text="â˜€ï¸", width=3,
                                  command=self.toggle_theme, style='Icon.TButton')
        self.theme_btn.pack(side=tk.RIGHT, padx=5)
        
        # æ¸…é™¤å†å²æŒ‰é’®
        self.clear_btn = ttk.Button(btn_frame, text="ğŸ—‘ï¸", width=3,
                                  command=self.clear_history, style='Icon.TButton')
        self.clear_btn.pack(side=tk.RIGHT, padx=5)
        
    def create_chat_area(self):
        # èŠå¤©æ˜¾ç¤ºåŒºåŸŸ
        self.chat_display = scrolledtext.ScrolledText(
            self.main_frame, 
            wrap=tk.WORD, 
            width=70, 
            height=20,
            font=('Helvetica', 10),
            bg=self.current_theme['input_bg'],
            fg=self.current_theme['fg'],
            insertbackground=self.current_theme['fg'],
            relief="flat",
            padx=15,
            pady=10
        )
        self.chat_display.grid(row=2, column=0, sticky=(tk.W, tk.E, tk.N, tk.S), padx=5, pady=5)
        
        # é…ç½®æ¶ˆæ¯æ ·å¼
        self.chat_display.tag_configure('user', 
                                      foreground='#0078d4',
                                      font=('Helvetica', 10, 'bold'))
        self.chat_display.tag_configure('bot', 
                                      foreground='#28a745',
                                      font=('Helvetica', 10, 'bold'))
        self.chat_display.tag_configure('message',
                                      font=('Helvetica', 10))
        self.chat_display.tag_configure('suggestion', 
                                      foreground='#6c757d',
                                      font=('Helvetica', 10, 'italic'),
                                      underline=True)
        # ä½¿æ–‡æœ¬æ¡†åªè¯»
        self.chat_display.bind("<Key>", lambda e: "break")
        
    def create_input_area(self):
        input_frame = ttk.Frame(self.main_frame, style='Modern.TFrame')
        input_frame.grid(row=3, column=0, sticky=(tk.W, tk.E), pady=(5, 0))
        
        # æ–‡ä»¶æ‹–æ”¾åŒºåŸŸ
        drop_text = "æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œ æˆ– ç‚¹å‡»é€‰æ‹©" if TkinterDnD else "ç‚¹å‡»é€‰æ‹©æ–‡ä»¶"
        self.drop_label = ttk.Label(
            input_frame, 
            text=drop_text,
            style='Modern.TLabel',
            cursor="hand2"  # æ·»åŠ æ‰‹å‹å…‰æ ‡
        )
        self.drop_label.grid(row=0, column=0, columnspan=2, sticky=(tk.W, tk.E), pady=(0, 5))
        self.drop_label.bind('<Button-1>', lambda e: self.select_file())
        
        # æ¶ˆæ¯è¾“å…¥æ¡†
        self.message_input = scrolledtext.ScrolledText(
            input_frame, 
            wrap=tk.WORD, 
            width=50, 
            height=3,
            font=('Helvetica', 10),
            bg=self.current_theme['input_bg'],
            fg=self.current_theme['fg'],
            insertbackground=self.current_theme['fg'],  # å…‰æ ‡é¢œè‰²
            relief="flat",  # æ‰å¹³åŒ–è®¾è®¡
            padx=10,  # å†…è¾¹è·
            pady=5
        )
        self.message_input.grid(row=1, column=0, padx=5, pady=5, sticky=(tk.W, tk.E))
        
        # å‘é€æŒ‰é’®
        self.send_btn = ttk.Button(input_frame, text="å‘é€", 
                                 command=self.send_message, style='Modern.TButton')
        self.send_btn.grid(row=1, column=1, padx=5, pady=5)
        
        # æ–‡ä»¶åæ˜¾ç¤º
        self.file_label = ttk.Label(input_frame, text="", style='Modern.TLabel')
        self.file_label.grid(row=2, column=0, columnspan=2, sticky=tk.W, padx=5)
        
        # é…ç½®åˆ—æƒé‡
        input_frame.grid_columnconfigure(0, weight=1)
        
    def bind_shortcuts(self):
        # ç»‘å®šå¿«æ·é”®
        self.root.bind('<Control-Return>', lambda e: self.send_message())
        self.root.bind('<Control-l>', lambda e: self.clear_history())
        
        # åªåœ¨æŒæ‹–æ”¾æ—¶æ·»åŠ æ‹–æ”¾åŠŸèƒ½
        if TkinterDnD:
            self.drop_label.drop_target_register(DND_FILES)
            self.drop_label.dnd_bind('<<Drop>>', self.handle_drop)
            self.message_input.drop_target_register(DND_FILES)
            self.message_input.dnd_bind('<<Drop>>', self.handle_drop)
        
    def toggle_theme(self):
        # åˆ‡æ¢ä¸»é¢˜
        self.current_theme = (ModernUI.DARK_THEME 
                            if self.current_theme == ModernUI.LIGHT_THEME 
                            else ModernUI.LIGHT_THEME)
        self.setup_theme()
        self.update_colors()
        
    def clear_history(self):
        if messagebox.askyesno("ç¡®è®¤", "ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©å†å²å—ï¼Ÿ"):
            self.chat_display.delete(1.0, tk.END)
            
    def show_emoji_picker(self):
        # åˆ›å»ºè¡¨æƒ…é€‰æ‹©çª—å£
        emoji_window = tk.Toplevel(self.root)
        emoji_window.title("é€‰æ‹©è¡¨æƒ…")
        emoji_window.geometry("200x200")
        
        common_emojis = ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ¤”', 'ğŸ‘', 'â¤ï¸', 'ğŸ˜', '', 'âœ¨']
        for i, emoji_char in enumerate(common_emojis):
            btn = ttk.Button(
                emoji_window, 
                text=emoji_char,
                command=lambda e=emoji_char: self.insert_emoji(e, emoji_window)
            )
            btn.grid(row=i//4, column=i%4, padx=5, pady=5)
            
    def insert_emoji(self, emoji_char, window):
        self.message_input.insert(tk.INSERT, emoji_char)
        window.destroy()
        
    def handle_drop(self, event):
        file_path = event.data
        if file_path:
            self.selected_file = file_path
            self.file_label.config(text=f"å·²é€‰æ‹©: {os.path.basename(file_path)}")
            
    def update_colors(self):
        # æ›´æ–°å„ä¸ªç»„ä»¶çš„é¢œè‰²
        self.chat_display.configure(
            bg=self.current_theme['input_bg'],
            fg=self.current_theme['fg']
        )
        self.message_input.configure(
            bg=self.current_theme['input_bg'],
            fg=self.current_theme['fg']
        )
        
    def show_sending_status(self):
        self.update_status("æ­£åœ¨å‘é€...")

    def hide_sending_status(self):
        if hasattr(self, 'status_label'):
            self.status_label.destroy()

    def select_file(self):
        file_types = [
            ("æ‰€æœ‰æ”¯æŒçš„æ–‡ä»¶", "*.png *.jpg *.jpeg *.gif *.pdf *.doc *.docx *.xls *.xlsx *.ppt *.pptx"),
            ("å›¾ç‰‡æ–‡ä»¶", "*.png *.jpg *.jpeg *.gif"),
            ("æ–‡æ¡£æ–‡ä»¶", "*.pdf *.doc *.docx *.xls *.xlsx *.ppt *.pptx"),
            ("æ‰€æœ‰æ–‡ä»¶", "*.*")
        ]
        filename = filedialog.askopenfilename(
            title="é€‰æ‹©æ–‡ä»¶",
            filetypes=file_types
        )
        if filename:
            self.selected_file = filename
            self.file_label.config(text=f"å·²é€‰æ‹©: {os.path.basename(filename)}")

    def send_message(self, event=None):
        message = self.message_input.get("1.0", tk.END).strip()
        if not message:
            return
            
        # æ¯æ¬¡å‘é€æ¶ˆæ¯æ—¶ç”Ÿæˆæ–°çš„user_id
        user_id = f"user_{int(time.time())}"
        
        # ä¿å­˜æ¶ˆæ¯å†…å®¹ä»¥ä¾¿å¤±è´¥æ—¶æ¢å¤
        self.saved_message = message
        self.saved_file = self.selected_file
        
        # ç«‹å³æ¸…ç©ºè¾“å…¥æ¡†å’Œæ–‡ä»¶é€‰æ‹©
        self.message_input.delete("1.0", tk.END)
        self.selected_file = None
        self.file_label.config(text="")
            
        # ç¦ç”¨å‘é€æŒ‰é’®å’Œè¾“å…¥æ¡†
        self.send_btn.config(state='disabled')
        self.message_input.config(state='disabled')
        
        # æ˜¾ç¤ºå‘é€çŠ¶æ€
        self.show_sending_status()
        
        # åœ¨èŠå¤©æ˜¾ç¤ºåŒºåŸŸæ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        self.chat_display.insert(tk.END, "\nğŸ‘¤ æˆ‘: ", 'user')
        self.chat_display.insert(tk.END, f"{message}\n", 'message')
        if self.saved_file:
            self.chat_display.insert(tk.END, f"ğŸ“ {os.path.basename(self.saved_file)}\n", 'message')
        self.chat_display.see(tk.END)
        
        # åˆ›å»ºæ–°çº¿ç¨‹å‘é€æ¶ˆæ¯
        thread = threading.Thread(target=self.send_message_thread, args=(message, user_id, 0))
        thread.daemon = True
        thread.start()
        
    def send_message_thread(self, message, user_id, retry_count=0):
        max_retries = 3  # æœ€å¤§é‡è¯•æ¬¡æ•°
        retry_delay = 2  # é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰
        
        def is_network_error(e):
            error_str = str(e).lower()
            return any(text in error_str for text in [
                'connectionerror',
                'timeout',
                'connection refused',
                'network unreachable',
                'getaddrinfo failed',
                'no route to host',
                'connection reset'
            ])

        try:
            print(f"\nå°è¯•å‘é€æ¶ˆæ¯ (ç¬¬{retry_count + 1}æ¬¡å°è¯•)")
            print(f"ç”¨æˆ·ID: {user_id}")
            print(f"æ¶ˆæ¯å†…å®¹: {message}")
            
            # å°è¯•å‘é€æ¶ˆæ¯
            result = self.api.send_message(
                bot_id="7447144311730569255",
                user_id=user_id,
                message=message,
                user_name=f"User_{user_id}",
                file_path=self.saved_file
            )
            
            print("\næ¥æ”¶åˆ°APIå“åº”:")
            print(json.dumps(result, ensure_ascii=False, indent=2))
            
            # å‘é€æˆåŠŸï¼Œæ›´æ–°UI
            self.root.after(0, self.update_chat_display, result)
            
        except Exception as e:
            print(f"\nå‘é€æ¶ˆæ¯æ—¶å‡ºé”™: {str(e)}")
            print(f"é”™è¯¯ç±»å‹: {type(e).__name__}")
            import traceback
            print("è¯¦ç»†é”™è¯¯ä¿¡æ¯:")
            print(traceback.format_exc())
            
            if retry_count < max_retries and is_network_error(e):
                # è®¡ç®—å‰©ä½™é‡è¯•æ¬¡æ•°
                remaining = max_retries - retry_count
                
                # æ›´æ–°çŠ¶æ€æ¶ˆæ¯
                status_msg = f"ç½‘ç»œä¸ç¨³å®šï¼Œ{retry_delay}ç§’åè‡ªåŠ¨é‡è¯•... (å‰©ä½™{remaining}æ¬¡)"
                print(f"\n{status_msg}")
                self.root.after(0, self.update_status, status_msg)
                
                # å»¶è¿Ÿé‡è¯•
                time.sleep(retry_delay)
                
                # é€’å¢é‡è¯•å»¶è¿Ÿï¼ˆæŒ‡æ•°é€€é¿ï¼‰
                retry_delay *= 1.5
                
                # é‡è¯•
                self.send_message_thread(message, user_id, retry_count + 1)
                return
            else:
                print("\nè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°æˆ–éç½‘ç»œé”™è¯¯ï¼Œåœæ­¢é‡è¯•")
            
            # å¦‚æœæ˜¯æœ€åä¸€æ¬¡é‡è¯•å¤±è´¥
            if retry_count == max_retries - 1:
                error_msg = f"å‘é€å¤±è´¥: {str(e)}"
                print(f"\n{error_msg}")
                # æ¢å¤è¾“å…¥å†…å®¹
                self.root.after(0, self.restore_failed_message)
                # æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
                self.root.after(0, self.update_status, error_msg)
                # 3ç§’åæ¸…é™¤çŠ¶æ€æ¶ˆæ¯
                self.root.after(3000, self.hide_sending_status)
                # æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†
                self.root.after(0, self.show_error, error_msg)
        finally:
            if retry_count == 0:  # åªåœ¨æœ€åä¸€æ¬¡é‡è¯•åé‡ç½®UI
                print("\né‡ç½®UIæ§ä»¶çŠ¶æ€")
                self.root.after(0, self.enable_controls)

    def clear_input(self):
        """æ¸…ç©ºè¾“å…¥æ¡†å’Œç›¸å…³çŠ¶æ€"""
        self.message_input.delete("1.0", tk.END)
        self.selected_file = None
        self.file_label.config(text="")
        self.saved_message = None
        self.saved_file = None

    def restore_failed_message(self):
        """æ¢å¤å‘é€å¤±è´¥çš„æ¶ˆæ¯åˆ°è¾“å…¥æ¡†"""
        if hasattr(self, 'saved_message') and self.saved_message:
            # åˆ é™¤æœ€åä¸€æ¡æœªå‘é€æˆåŠŸçš„æ¶ˆæ¯æ˜¾ç¤º
            last_line_start = self.chat_display.index("end-2c linestart")
            self.chat_display.delete(last_line_start, tk.END)
            
            # æ¢å¤è¾“å…¥å†…å®¹
            self.message_input.delete("1.0", tk.END)
            self.message_input.insert("1.0", self.saved_message)
            
            # æ¢å¤æ–‡ä»¶é€‰æ‹©
            if hasattr(self, 'saved_file') and self.saved_file:
                self.selected_file = self.saved_file
                self.file_label.config(text=f"å·²é€‰æ‹©: {os.path.basename(self.saved_file)}")

    def enable_controls(self):
        """é‡æ–°å¯ç”¨æ§ä»¶"""
        self.send_btn.config(state='normal')
        self.message_input.config(state='normal')
        self.message_input.focus_set()  # å°†ç„¦ç‚¹è®¾ç½®å›è¾“å…¥æ¡†

    def update_status(self, message):
        """æ›´æ–°çŠ¶æ€æ¶ˆæ¯"""
        if hasattr(self, 'status_label'):
            self.status_label.destroy()
        
        self.status_label = ttk.Label(
            self.main_frame, 
            text=message,
            style='Status.TLabel'  # ä½¿ç”¨ç‰¹æ®Šçš„çŠ¶æ€æ ‡ç­¾æ ·å¼
        )
        self.status_label.grid(row=1, column=0, sticky=tk.W, padx=5)

    def update_chat_display(self, result):
        """æ›´æ–°èŠå¤©æ˜¾ç¤ºåŒºåŸŸ"""
        try:
            print("\nå¼€å§‹æ›´æ–°èŠå¤©æ˜¾ç¤º...")
            if result.get("code") == 0 and "data" in result:
                messages = result["data"]
                for msg in messages:
                    content_type = msg.get("content_type", "")
                    msg_type = msg.get("type", "")
                    
                    # è·³è¿‡verboseç±»å‹çš„æ¶ˆæ¯
                    if msg_type == "verbose":
                        continue
                    
                    if msg_type == "answer" and content_type == "text":
                        # æ˜¾ç¤ºæœºå™¨äººçš„æ–‡æœ¬å›ç­”
                        content = msg.get("content", "")
                        if content.strip():  # ç¡®ä¿å†…å®¹ä¸ä¸ºç©º
                            self.chat_display.insert(tk.END, "\nğŸ’¬ AIåŠ©æ‰‹: ", 'bot')
                            self.chat_display.insert(tk.END, f"{content}\n", 'message')
                            print(f"æ˜¾ç¤ºAIå›å¤: {content}")
                    
                    elif msg_type == "answer" and content_type == "object_string":
                        # å¤„ç†å›¾ç‰‡æ¶ˆæ¯
                        try:
                            content_obj = json.loads(msg.get("content", "[]"))
                            if isinstance(content_obj, list):
                                for item in content_obj:
                                    if item.get("type") == "image" and item.get("url"):
                                        self.chat_display.insert(tk.END, "\nğŸ’¬ AIåŠ©æ‰‹: ", 'bot')
                                        self.chat_display.insert(tk.END, "ç”Ÿæˆçš„å›¾ç‰‡ï¼š\n", 'message')
                                        self.display_image_from_url(item["url"])
                                        print(f"æ˜¾ç¤ºå›¾ç‰‡: {item['url']}")
                        except json.JSONDecodeError as e:
                            print(f"è§£æå›¾ç‰‡æ¶ˆæ¯å¤±è´¥: {e}")
                            print(f"åŸå§‹æ¶ˆæ¯å†…å®¹: {msg.get('content')}")
                            
                    elif msg_type == "follow_up":
                        # æ˜¾ç¤ºå»ºè®®çš„é—®é¢˜
                        content = msg.get("content", "")
                        if content.strip():  # ç¡®ä¿å†…å®¹ä¸ä¸ºç©º
                            suggestion_start = self.chat_display.index("end-1c")
                            self.chat_display.insert(tk.END, "  ğŸ’¡ ", 'suggestion')
                            self.chat_display.insert(tk.END, f"{content}\n", 'suggestion')
                            suggestion_end = self.chat_display.index("end-1c")
                            
                            # ä¸ºå»ºè®®æ–‡æœ¬æ·»åŠ æ ‡ç­¾å’Œç»‘å®šç‚¹å‡»äº‹ä»¶
                            tag_name = f"suggestion_{time.time()}"
                            self.chat_display.tag_add(tag_name, suggestion_start, suggestion_end)
                            self.chat_display.tag_bind(tag_name, '<Button-1>', 
                                                    lambda e, text=content: self.send_suggestion(text))
                            
                            # æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
                            self.chat_display.tag_config(tag_name, foreground='#0078d4')
                            self.chat_display.tag_bind(tag_name, '<Enter>', 
                                                    lambda e: self.chat_display.config(cursor='hand2'))
                            self.chat_display.tag_bind(tag_name, '<Leave>', 
                                                    lambda e: self.chat_display.config(cursor=''))
                            print(f"æ˜¾ç¤ºå»ºè®®: {content}")
                
                # ç¡®ä¿æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
                self.chat_display.see(tk.END)
                # å‘é€æˆåŠŸåï¼Œæ¸…é™¤ä¿å­˜çš„æ¶ˆæ¯
                self.saved_message = None
                self.saved_file = None
                print("èŠå¤©æ˜¾ç¤ºæ›´æ–°å®Œæˆ")
            else:
                print(f"APIå“åº”é”™è¯¯: code={result.get('code')}, msg={result.get('msg')}")
                
        except Exception as e:
            print(f"æ›´æ–°èŠå¤©æ˜¾ç¤ºæ—¶å‡ºé”™: {str(e)}")
            import traceback
            print("è¯¦ç»†é”™è¯¯ä¿¡æ¯:")
            print(traceback.format_exc())

    def send_suggestion(self, suggestion_text):
        """å¤„ç†å»ºè®®æ¶ˆæ¯çš„ç‚¹å‡»äº‹ä»¶"""
        # å°†å»ºè®®æ–‡æœ¬è®¾ç½®åˆ°è¾“å…¥æ¡†å¹¶ç«‹å³å‘é€
        self.message_input.delete("1.0", tk.END)
        self.message_input.insert("1.0", suggestion_text)
        # è‡ªåŠ¨å‘é€æ¶ˆæ¯
        self.send_message()

    def show_error(self, error_message):
        messagebox.showerror("é”™è¯¯", error_message)

    def display_image_from_url(self, url):
        try:
            # ä¸‹è½½å›¾ç‰‡
            with self.session.get(url, stream=True) as response:
                response.raise_for_status()
                
                # åˆ›å»ºä¸´æ—¶å›¾ç‰‡æ–‡ä»¶
                import tempfile
                with tempfile.NamedTemporaryFile(delete=False, suffix='.png') as tmp_file:
                    for chunk in response.iter_content(chunk_size=8192):
                        if chunk:
                            tmp_file.write(chunk)
                    tmp_file_path = tmp_file.name
            
            # ä½¿ç”¨PILæ‰“å¼€å›¾ç‰‡å¹¶è°ƒæ•´å¤§å°
            image = Image.open(tmp_file_path)
            # è®¡ç®—è°ƒæ•´åçš„å¤§å°ï¼ˆä¿æŒå®½é«˜æ¯”ï¼Œæœ€å¤§å®½åº¦ä¸º400åƒç´ ï¼‰
            max_width = 400
            ratio = max_width / image.width
            new_size = (max_width, int(image.height * ratio))
            image = image.resize(new_size, Image.Resampling.LANCZOS)
            
            # è½¬æ¢ä¸ºPhotoImage
            photo = ImageTk.PhotoImage(image)
            
            # åœ¨æ–‡æœ¬æ¡†ä¸­åˆ›å»ºå›¾ç‰‡æ ‡ç­¾
            self.chat_display.image_create(tk.END, image=photo)
            # ä¿æŒå¯¹å›¾ç‰‡çš„å¼•ç”¨ï¼ˆé˜²æ­¢è¢«åƒåœ¾å›æ”¶ï¼‰
            if not hasattr(self, 'image_refs'):
                self.image_refs = []
            self.image_refs.append(photo)
            
            # æ·»åŠ æ¢è¡Œ
            self.chat_display.insert(tk.END, "\n")
            
            # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
            os.unlink(tmp_file_path)
            
        except Exception as e:
            print(f"å›¾ç‰‡æ˜¾ç¤ºé”™è¯¯: {str(e)}")
            self.chat_display.insert(tk.END, f"[å›¾ç‰‡åŠ è½½å¤±è´¥: {str(e)}]\n", 'message')

def main():
    if TkinterDnD:
        # å¦‚æœæ”¯æŒæ‹–æ”¾ï¼Œä½¿ç”¨ TkinterDnD.Tk
        root = TkinterDnD.Tk()
        # è®¾ç½®ä¸»é¢˜
        style = ttk.Style(root)
        style.theme_use('clam')
    else:
        # å¦åˆ™ä½¿ç”¨æ™®é€šçš„ Tk
        root = tk.Tk()
        style = ttk.Style(root)
        style.theme_use('clam')
    
    app = CozeGUI(root)
    root.mainloop()

if __name__ == "__main__":
    main()